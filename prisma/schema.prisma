generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum Role {
  ADMIN
  STAFF
}

enum TableType {
  POOL
  CAROM
  SNOOKER
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  RESERVED
}

enum OrderType {
  SESSION
  WALK_IN
  TAKE_AWAY
}

enum OrderStatus {
  PENDING
  PREPARING
  SERVED
  CANCELLED
}

enum InventoryTransactionType {
  IMPORT
  SALE
  INTERNAL
  SPOILAGE
  ADJUSTMENT
}

enum DiscountType {
  TABLE
  PRODUCT
  GENERAL
}

// Models
model User {
  id        String   @id @default(uuid(7))
  name      String
  email     String   @unique
  phone     String   @unique
  password  String
  role      Role     @default(STAFF)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders           Order[]
  createdInventory InventoryTransaction[]
  createdExpenses  Expense[]
  createdBatches   InventoryBatch[]
}

model Table {
  id         String      @id @default(uuid(7))
  name       String      @unique
  type       TableType
  hourlyRate Int
  status     TableStatus @default(AVAILABLE)

  sessions TableSession[]

  @@index([status])
}

model TableSession {
  id        String    @id @default(uuid(7))
  table     Table     @relation(fields: [tableId], references: [id])
  tableId   String
  startTime DateTime  @default(now())
  endTime   DateTime?

  orders Order[]

  billId String?
  bill   Bill?   @relation(fields: [billId], references: [id])

  @@index([tableId])
  @@index([billId])
}

model Category {
  id          String    @id @default(uuid(7))
  name        String    @unique
  description String?
  products    Product[]
}

model Product {
  id          String @id @default(uuid(7))
  name        String @unique
  unit        String
  description String
  price       Int // Giá bán
  minStock    Int

  category   Category @relation(fields: [categoryId], references: [id])
  categoryId String

  orderProducts OrderProduct[]
  inventory     InventoryTransaction[]
  batches       InventoryBatch[]

  @@index([categoryId])
}

// Quản lý LÔ HÀNG (FIFO)
model InventoryBatch {
  id        String   @id @default(uuid(7))
  product   Product  @relation(fields: [productId], references: [id])
  productId String

  quantity    Int      // Số lượng còn lại
  costPerUnit Int      // Giá nhập đơn vị
  importedAt  DateTime @default(now())

  createdBy User   @relation(fields: [userId], references: [id])
  userId    String

  batchSales BatchSale[]

  @@index([productId, quantity]) // Composite index cho query FIFO
  @@index([importedAt])
}

// Theo dõi xuất từ lô nào
model BatchSale {
  id      String @id @default(uuid(7))
  batch   InventoryBatch @relation(fields: [batchId], references: [id])
  batchId String

  orderProduct   OrderProduct @relation(fields: [orderProductId], references: [id])
  orderProductId String

  quantity    Int // Số lượng xuất
  costPerUnit Int // Giá vốn (snapshot)

  @@index([batchId])
  @@index([orderProductId])
}

model Order {
  id     String      @id @default(uuid(7))
  type   OrderType
  status OrderStatus @default(PENDING)

  user   User   @relation(fields: [userId], references: [id])
  userId String

  session   TableSession? @relation(fields: [sessionId], references: [id])
  sessionId String?

  bill   Bill?   @relation(fields: [billId], references: [id])
  billId String?

  products  OrderProduct[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([sessionId])
  @@index([billId])
  @@index([createdAt])
}

model OrderProduct {
  id        String  @id @default(uuid(7))
  order     Order   @relation(fields: [orderId], references: [id])
  orderId   String
  product   Product @relation(fields: [productId], references: [id])
  productId String

  quantity Int
  price    Int // Giá bán (snapshot)
  cost     Int // Giá vốn TB (tính từ FIFO)

  batchSales BatchSale[]

  @@index([orderId])
  @@index([productId])
}

model Bill {
  id String @id @default(uuid(7))

  grossTableRevenue   Int @default(0) // Doanh thu bàn gốc
  grossProductRevenue Int @default(0) // Doanh thu sản phẩm gốc
  productCost         Int @default(0) // Chi phí sản phẩm

  totalDiscount Int @default(0) // Tổng giảm giá
  netRevenue    Int @default(0) // Doanh thu thực
  profit        Int @default(0) // Lãi
  total         Int @default(0) // Tổng tiền

  paidAt    DateTime?
  createdAt DateTime  @default(now())

  orders        Order[]
  tableSessions TableSession[]
  discounts     BillDiscount[]

  @@index([createdAt])
  @@index([paidAt])
}

model BillDiscount {
  id     String       @id @default(uuid(7))
  bill   Bill         @relation(fields: [billId], references: [id])
  billId String

  type   DiscountType
  amount Int
  reason String?

  createdAt DateTime @default(now())

  @@index([billId])
}

model InventoryTransaction {
  id        String  @id @default(uuid(7))
  product   Product @relation(fields: [productId], references: [id])
  productId String

  type     InventoryTransactionType
  quantity Int  // âm = xuất, dương = nhập
  cost     Int  // Giá vốn (TB nếu FIFO, hoặc giá nhập)

  note      String
  createdAt DateTime @default(now())

  createdBy User   @relation(fields: [userId], references: [id])
  userId    String

  @@index([productId])
  @@index([type])
  @@index([createdAt])
}

model Expense {
  id          String   @id @default(uuid(7))
  type        String
  amount      Int
  description String?
  paidAt      DateTime @default(now())

  createdBy User   @relation(fields: [userId], references: [id])
  userId    String

  @@index([type])
  @@index([paidAt])
}
